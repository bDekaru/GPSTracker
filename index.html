<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title>GPSTracker</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="robots" content="noindex, nofollow, noarchive" />
	<meta name="MSSmartTagsPreventParsing" content="true" />
	<meta http-equiv="imagetoolbar" content="no" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link type="image/ico" rel="shortcut icon" href="/favicon.ico" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
	<script src="leaflet.textpath.js"></script>
	<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
	<style type="text/css">
	<!--
		body {
		padding: 0;
		margin: 0;
		}
		html, body, #map {
		height: 100%;
		}
	-->
	</style>
</head>
<body>

<div id="map" style="width: 100%; height: 100%;"></div>

<script type="text/javascript">


	/*** Adjust the following location (URL) to your PHP script ***/

	var phpScript = 'track.php';

        /*** If you've got an API Key for https://www.thunderforest.com/maps/ add it here and uncomment ***/

	//var TFkey = 'ThunderForestKey';

	var routeFile = 'data/route.gpx';
	var track = 0;
	var center = 0;

	// Initialize some Variables
	var autoPan = 1;
	var showRoute = 1;
	var showTrack = 0;

	// Maps
	//
	// OpenStreetMap
	var osmUrl = 'https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', // http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png
		osmAttribution = 'Map © <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap Contributors</a> (<a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_blank">CC-by-SA 2.0</a>)',
		osm = new L.TileLayer(osmUrl, {maxZoom: 18, attribution: osmAttribution});
	// Thunderforest - OpenCycleMap
	var cyclemapUrl = "https://tile.thunderforest.com/cycle/{z}/{x}/{y}{r}.png"
                       + ( typeof TFkey !== "undefined" ? "?apikey=" + TFkey : "" ),
		cyclemapAttribution = 'Maps © <a href="https://www.thunderforest.com" target="_blank">Thunderforest</a>, Data © <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap Contributors</a>',
		cyclemap = new L.TileLayer(cyclemapUrl, {maxZoom: 18, attribution: cyclemapAttribution});
        // Thunderforest - Outdoors
        var outdoorsmapUrl = "https://tile.thunderforest.com/outdoors/{z}/{x}/{y}{r}.png"
                       + ( typeof TFkey !== "undefined" ? "?apikey=" + TFkey : "" ),
                outdoorsmap = new L.TileLayer(outdoorsmapUrl, {maxZoom: 18, attribution: cyclemapAttribution});
        // Thunderforest - Outdoors
        var landscapemapUrl = "https://tile.thunderforest.com/landscape/{z}/{x}/{y}{r}.png"
                       + ( typeof TFkey !== "undefined" ? "?apikey=" + TFkey : "" ),
                landscapemap = new L.TileLayer(landscapemapUrl, {maxZoom: 18, attribution: cyclemapAttribution});
	// OpentopoMap
	var opentopoUrl = 'https://b.tile.opentopomap.org/{z}/{x}/{y}.png',
		opentopoAttribution = 'Map © <a href="https://opentopomap.org/copyright" target="_blank">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/" target="_blank">CC-BY-SA</a>)',
		opentopo = new L.TileLayer(opentopoUrl, {maxZoom: 18, attribution: opentopoAttribution});
	/* // Hike and Bike
	var hikebikeUrl = 'http://{s}.tiles.wmflabs.org/hikebike/{z}/{x}/{y}.png',
		hikebike = new L.TileLayer(hikebikeUrl, {maxZoom: 18, attribution: osmAttribution});
	// ESRI
	var esriUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}.png',
		esriAttribution = "National Geographic, Esri, DeLorme, NAVTEQ",
		esri = new L.TileLayer(esriUrl, {maxZoom: 16, attribution: esriAttribution}); */
	// Googly Hybrid
	var googleUrl = 'https://mts.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
		googleAttribution = "(c)2015 Google - Map data",
		google = new L.TileLayer(googleUrl, {maxZoom: 28, attribution: googleAttribution});

	// Shaders
	//
	// Hillshading
	/* var hillshadingUrl = 'http://{s}.tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png',
		hillshadingAttribution = 'Hillshading: SRTM3 v2 <a href="http://www2.jpl.nasa.gov/srtm/" target="_blank">(NASA)</a>',
		hillshading = new L.TileLayer(hillshadingUrl, {maxZoom: 18, attribution: hillshadingAttribution});
	// Contour Lines
	var contourshadingUrl = 'http://129.206.66.245:8006/tms_il.ashx?x={x}&y={y}&z={z}',
		contourshadingAttribution = 'Contour Data by <a href="http://korona.geog.uni-heidelberg.de/contact.html" target="_blank">Korona</a>',
		contourshading = new L.TileLayer(contourshadingUrl, {maxZoom: 18, attribution: contourshadingAttribution});
	// Waymarked
	var waymarkedshadinghikeUrl = 'http://tile.waymarkedtrails.org/hiking/{z}/{x}/{y}.png',
		waymarkedshadinghikeAttribution = 'Trails Data by <a href="http://www.waymarkedtrails.org" target="_blank">Waymarkedtrails</a>',
		waymarkedshadinghike = new L.TileLayer(waymarkedshadinghikeUrl, {maxZoom: 18, attribution: waymarkedshadinghikeAttribution});
	// Waymarked
	var waymarkedshadingbikeUrl = 'http://tile.waymarkedtrails.org/cycling/{z}/{x}/{y}.png',
		waymarkedshadingbikeAttribution = 'Trails Data by <a href="http://www.waymarkedtrails.org" target="_blank">Waymarkedtrails</a>',
		waymarkedshadingbike = new L.TileLayer(waymarkedshadingbikeUrl, {maxZoom: 18, attribution: waymarkedshadingbikeAttribution}); */

	var baseMaps = {
		"OpenCycleMap": cyclemap,
		"OpenStreetMap": osm,
		/* "OutdoorsMap": outdoorsmap, */
		/* "LandscapeMap": landscapemap, */
		 "OpenTopoMap": opentopo,
		/* "Hike & Bike": hikebike, */
		"Google Hybrid": google,
		/* "ESRI": esri */
	};
	var overlayMaps = {
		/* "Hillshading": hillshading,
		"Trails": waymarkedshadinghike,
		"Radrouten": waymarkedshadingbike,
		"Contour Lines": contourshading */
	};
	var layersControl = new L.Control.Layers(baseMaps, overlayMaps);

	// Set default until the first update
	var map = new L.Map('map', {
		center: new L.LatLng(-26.9215, -49.0591),
		zoom: 16,
		layers: [cyclemap]
	});
	map.addControl(layersControl);
	
	var route = new L.GPX(routeFile, {
  		async: true,
  		marker_options: {
			'': '',
    		startIconUrl: '',
    		endIconUrl: '',
    		shadowUrl: ''
  	}
	}).on('loaded').addTo(map);

	route.on('mouseover', function () {
        this.setText('  ►  ', {repeat: true, attributes: {fill: 'red'}});
    });

    route.on('mouseout', function () {
        this.setText(null);
    });

	var marker = L.marker([-26.9215, -49.0591]);
	marker.addTo(map);
	marker.bindPopup("<b>Offline</b>").openPopup();
	var circle = L.circle([-26.9215, -49.0591], 100, {
		color: 'blue',
		fillColor: '#f03',
		fillOpacity: 0.5
	}).addTo(map);

	// Create Auto-Pan control for to switch auto panning of map on/off
	var AutoPanCheckbox = L.control({position: 'topright'});
	AutoPanCheckbox.onAdd = function (map) {
		var div = L.DomUtil.create('div', 'AutoPanCheckbox');

		div.innerHTML = '<b><form><input id="AutoPanCheckbox" type="checkbox"/>Follow</form></b>'; 
		return div;
	};
	AutoPanCheckbox.addTo(map);
	document.getElementById("AutoPanCheckbox").checked = autoPan;

	// Add the event handler so that panning gets (de-)activated
	function handleAutoPan() {
		if (this.checked == 1) {
			autoPan = 1;
		} else {
			autoPan = 0;
		}
	//	alert("Clicked, checked = " + this.checked + " / " + autoPan);
	};

	document.getElementById ("AutoPanCheckbox").addEventListener ("click", handleAutoPan, false);

	var ShowRouteCheckbox = L.control({position: 'topright'});
	ShowRouteCheckbox.onAdd = function (map) {
		var div = L.DomUtil.create('div', 'ShowRouteCheckbox');

		div.innerHTML = '<b><form><input id="ShowRouteCheckbox" type="checkbox"/>Show Route</form></b>'; 
		return div;
	};
	ShowRouteCheckbox.addTo(map);
	document.getElementById("ShowRouteCheckbox").checked = showRoute;

	function handleShowRoute() {
		if (this.checked == 1) {
			showRoute = 1;
			if(route != 0)
				map.addLayer(route);
		} else {
			showRoute = 0;
			if(route != 0)
				map.removeLayer(route);
		}
	//	alert("Clicked, checked = " + this.checked + " / " + showRoute);
	};

	document.getElementById ("ShowRouteCheckbox").addEventListener ("click", handleShowRoute, false);

	var ShowTrackCheckbox = L.control({position: 'topright'});
	ShowTrackCheckbox.onAdd = function (map) {
		var div = L.DomUtil.create('div', 'ShowTrackCheckbox');

		div.innerHTML = '<b><form><input id="ShowTrackCheckbox" type="checkbox"/>Show Track</form></b>'; 
		return div;
	};
	ShowTrackCheckbox.addTo(map);
	document.getElementById("ShowTrackCheckbox").checked = showTrack;

	function handleShowTrack() {
		if (this.checked == 1) {
			showTrack = 1;
			if(track != 0)
				map.addLayer(track);
		} else {
			showTrack = 0;
			if(track != 0)
				map.removeLayer(track);
		}
	//	alert("Clicked, checked = " + this.checked + " / " + showTrack);
	};

	document.getElementById ("ShowTrackCheckbox").addEventListener ("click", handleShowTrack, false);

	// Fetch current location data and update marker and popup-data
	var refreshPos = function(){
		$.getJSON(phpScript+'?view=1', function(data) {
			//alert(JSON.stringify(data)); // Output Data for debug
			marker.setLatLng([data.lat,data.lon]);
			circle.setLatLng([data.lat,data.lon]);
			circle.setRadius(data.acc);

			// Center the map on first load
			if (center < 1) {
				map.setView( [data.lat,data.lon], 15 )
				center = 1;
			}

			// Calculate the time of last update
			var lastupdate = data.now - data.time;
			var minutes = Math.floor(lastupdate / 60);
			var hours = Math.floor(minutes / 60);
			var days = Math.floor(hours / 24);
			var seconds = lastupdate % 60;
			minutes = minutes - hours * 60;
			hours = hours - days * 24;

			hours = hours < 9 ? "0"+hours : hours;
			minutes = minutes < 9 ? "0"+minutes : minutes;
			seconds = seconds < 9 ? "0"+seconds : seconds;

			// Calculate speed (m/sec -> km/h ...)
			var kmh = data.speed * 3.6;

			var popUpText =
				  days + 'd:' + hours + 'h:' + minutes + 'm:' + seconds + 's<br/>'
				+ 'Speed: ' + kmh.toFixed(0) + 'km/h<br/>'
				+ 'Altitude: ' + data.alt + 'm<br/>'
				+ 'Battery: ' + data.battery + '%<br/>'
				+ 'Signal: ' + data.gsm_signal + '%<br/>';

			if(data.message != "")
				popUpText = popUpText + '<br/>' + data.message;

			if (autoPan == 1) {
				map.panTo( [data.lat,data.lon] );
			}
			marker.setPopupContent(popUpText);
		})
	};

	// Fetch track
	var refreshGeo = function(){
		$.getJSON(phpScript+'?track=1', function(data) {
			if (data.error) { alert('Error: ' + data.error) }
			if(track != 0)
				map.removeLayer(track)
			track = L.geoJson(data, {
				style: {
					color: '#ff0000',
					weight: 5,
					opacity: 1
				}
			});
			if (showTrack == 1) {	
				map.addLayer(track);
			}
		});
	};

	// Refresh
	refreshPos();
	refreshGeo();

	setInterval(refreshPos,5000); // 5 sec
	setInterval(refreshGeo,5000); // 5 sec
</script>
